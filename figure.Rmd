---
title: "Multivariate Batch Effects"
author: "j1c"
date: "09/21/2022"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
---

```{r setup, include=FALSE}
library(knitr)

knitr::opts_chunk$set(echo = TRUE, tidy.opts=list(width.cutoff=60),tidy=TRUE)
```

```{r, message=FALSE}
require(tidyverse)
require(grid)
require(dplyr)
require(ggridges)
require(multcomp)
require(gridExtra)
require(parallel)
require(survey)
require(latex2exp)
require(energy)
require(gtable)
require(ggplotify)
require(kableExtra)
require(scales)
require(ggh4x)
require(cowplot)
#source('./causal_investigation_helpers.R')
```

# Figures


```{r}
select <- dplyr::select
mutate <- dplyr::mutate
arrange = dplyr::arrange

get_scaled_densities <- function(x, bw = 1.58) {
    res <- density(x, bw = bw)
    return(
        data.frame(
            x = res$x, y = res$y/max(res$y) *
                length(x)
        )
    )
}
```

```{r,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
csv <- read.csv("./data/composite_phenotypic_data.csv") %>% mutate(SITE_ID = gsub("_", "", SITE_ID))
dset.ord <- csv %>% select(c("Continent", "SITE_ID")) %>% arrange(Continent, SITE_ID) %>% distinct()

columns <- c("SITE_ID", "SUB_ID", "DX_GROUP", "SEX", "AGE_AT_SCAN", "Continent")
tdf <- csv %>%
    select(columns) %>%
    mutate(SITE_ID = sub("_", "", SITE_ID)) %>%
    mutate(SITE_ID = factor(SITE_ID, levels = dset.ord$SITE_ID, ordered = TRUE)) %>%
    mutate(Continent = factor(Continent, levels = unique(dset.ord$Continent))) %>%
    mutate(SEX=factor(SEX))
    

```

```{r,fig.height=11, fig.width=8.5}

plt <- (df <- tdf %>%
    group_by(SITE_ID, SEX, Continent) %>%
    do(get_scaled_densities(.$AGE_AT_SCAN)) %>%
    ungroup() %>%
    mutate(
        y = y/max(y) +
            as.numeric(SITE_ID)
    )) %>%
    ggplot(
        aes(
            ymin = as.numeric(SITE_ID),
            group = paste0(SITE_ID, SEX),
            #group=SITE_ID,
            color = SEX, fill = SEX, x = x, y = y, ymax = y
        )
    ) +
    geom_ribbon(alpha = 0.2) +
    geom_line(color = "black") +
    geom_jitter(
        data = tdf, aes(
            x = AGE_AT_SCAN, y = as.numeric(SITE_ID),
            color = factor(SEX)
        ),
        width = 0.25, height = 0.2, size = 0.1, inherit.aes = FALSE
    ) +
    scale_fill_manual(
        values = c(`1` = "red", `2` = "blue"),
        labels = c(`1` = "Female", `2` = "Male"),
        name = "Sex"
    ) +
    scale_color_manual(
        values = c(`1` = "red", `2` = "blue"),
        labels = c(`1` = "Female", `2` = "Male"),
        name = "Sex", aesthetics = "color"
    ) +
    scale_y_continuous(
        breaks = 1:length(levels(df$SITE_ID)),
        labels = levels(df$SITE_ID),
        name = "Dataset", expand = c(0.02, 0.02),
        position = "right"
    ) +
    xlab("Age") +
    theme_bw(base_size = 20) +
    facet_grid(
        "Continent~.",
        scales = "free", space = "free_y", switch = "y"
    ) +
    theme(panel.grid.minor = element_blank())


plt = plt %>%
    grid.arrange(left = ggpubr::text_grob("Continent", size = 25, rot = 90))

plt


```
```{r}
ggsave("./figures/abide_demographics.pdf", device="pdf", height = 11, width=8.5, unit="in", limitsize = FALSE)
ggsave("./figures/abide_demographics.png", device="png", height = 11, width=8.5, unit="in", limitsize = FALSE)
```


